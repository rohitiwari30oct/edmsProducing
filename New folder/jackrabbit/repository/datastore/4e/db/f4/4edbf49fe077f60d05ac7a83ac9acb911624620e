package jcrTest;

import java.security.AccessController;
import java.security.PrivilegedAction;
import java.security.PrivilegedActionException;
import java.security.PrivilegedExceptionAction;

import javax.jcr.Repository;
import javax.jcr.RepositoryException;
import javax.jcr.Session;
import javax.jcr.SimpleCredentials;
import javax.security.auth.Subject;

import org.apache.jackrabbit.api.JackrabbitSession;
import org.apache.jackrabbit.core.SessionImpl;
import org.apache.jackrabbit.core.security.principal.AdminPrincipal;

public class SessionExternal implements SessionManagerImpl{

	@Override
	public Session GetSession(Repository repository) throws PrivilegedActionException {
		Session session = null;
		try {
			//session = repository.login( new SimpleCredentials("sanjay", "redhat".toCharArray()), "default");
			session = repository.login( new SimpleCredentials("samresh", "password".toCharArray()), "default");
			//session = repository.login( new SimpleCredentials("ram", "google@2009".toCharArray()), "security");
			SessionImpl si = (SessionImpl) session;
			Subject subject  = si.getSubject();
			subject.getPrincipals().add(new AdminPrincipal("admin"));
			session = Subject.doAsPrivileged(subject, new PrivilegedExceptionAction<Session>() {
			    public Session run() throws Exception {
			        return repository.login();
			    }
			}, AccessController.getContext());
			;
			
			//Subject.doAsPrivileged(subject, action, null);
			//subject.getPrincipals();

		} catch (RepositoryException e) {
			e.printStackTrace();
		}
		return session;
	}
	
}
